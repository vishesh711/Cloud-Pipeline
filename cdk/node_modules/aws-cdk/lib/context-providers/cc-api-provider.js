"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CcApiContextProviderPlugin = void 0;
const sdk_provider_1 = require("../api/aws-auth/sdk-provider");
const error_1 = require("../toolkit/error");
const util_1 = require("../util");
class CcApiContextProviderPlugin {
    constructor(aws) {
        this.aws = aws;
    }
    /**
     * This returns a data object with the value from CloudControl API result.
     * args.typeName - see https://docs.aws.amazon.com/cloudcontrolapi/latest/userguide/supported-resources.html
     * args.exactIdentifier -  use CC API getResource.
     * args.propertyMatch - use CCP API listResources to get resources and propertyMatch to search through the list.
     * args.propertiesToReturn - Properties from CC API to return.
     */
    async getValue(args) {
        const cloudControl = (await (0, sdk_provider_1.initContextProviderSdk)(this.aws, args)).cloudControl();
        const result = await this.findResources(cloudControl, args);
        return result;
    }
    async findResources(cc, args) {
        if (args.exactIdentifier && args.propertyMatch) {
            throw new error_1.ContextProviderError(`Specify either exactIdentifier or propertyMatch, but not both. Failed to find resources using CC API for type ${args.typeName}.`);
        }
        if (!args.exactIdentifier && !args.propertyMatch) {
            throw new error_1.ContextProviderError(`Neither exactIdentifier nor propertyMatch is specified. Failed to find resources using CC API for type ${args.typeName}.`);
        }
        if (args.exactIdentifier) {
            // use getResource to get the exact indentifier
            return this.getResource(cc, args.typeName, args.exactIdentifier, args.propertiesToReturn);
        }
        else {
            // use listResource
            return this.listResources(cc, args.typeName, args.propertyMatch, args.propertiesToReturn);
        }
    }
    /**
     * Calls getResource from CC API to get the resource.
     * See https://docs.aws.amazon.com/cli/latest/reference/cloudcontrol/get-resource.html
     *
     * If the exactIdentifier is not found, then an empty map is returned.
     * If the resource is found, then a map of the identifier to a map of property values is returned.
     */
    async getResource(cc, typeName, exactIdentifier, propertiesToReturn) {
        var _a, _b, _c, _d, _e;
        const resultObjs = [];
        try {
            const result = await cc.getResource({
                TypeName: typeName,
                Identifier: exactIdentifier,
            });
            const id = (_b = (_a = result.ResourceDescription) === null || _a === void 0 ? void 0 : _a.Identifier) !== null && _b !== void 0 ? _b : '';
            if (id !== '') {
                const propsObject = JSON.parse((_d = (_c = result.ResourceDescription) === null || _c === void 0 ? void 0 : _c.Properties) !== null && _d !== void 0 ? _d : '');
                const propsObj = (0, util_1.getResultObj)(propsObject, (_e = result.ResourceDescription) === null || _e === void 0 ? void 0 : _e.Identifier, propertiesToReturn);
                resultObjs.push(propsObj);
            }
            else {
                throw new error_1.ContextProviderError(`Could not get resource ${exactIdentifier}.`);
            }
        }
        catch (err) {
            throw new error_1.ContextProviderError(`Encountered CC API error while getting resource ${exactIdentifier}. Error: ${err}`);
        }
        return resultObjs;
    }
    /**
     * Calls listResources from CC API to get the resources and apply args.propertyMatch to find the resources.
     * See https://docs.aws.amazon.com/cli/latest/reference/cloudcontrol/list-resources.html
     *
     * Since exactIdentifier is not specified, propertyMatch must be specified.
     * This returns an object where the ids are object keys and values are objects with keys of args.propertiesToReturn.
     */
    async listResources(cc, typeName, propertyMatch, propertiesToReturn) {
        var _a;
        const resultObjs = [];
        try {
            const result = await cc.listResources({
                TypeName: typeName,
            });
            (_a = result.ResourceDescriptions) === null || _a === void 0 ? void 0 : _a.forEach((resource) => {
                var _a, _b;
                const id = (_a = resource.Identifier) !== null && _a !== void 0 ? _a : '';
                if (id !== '') {
                    const propsObject = JSON.parse((_b = resource.Properties) !== null && _b !== void 0 ? _b : '');
                    const filters = Object.entries(propertyMatch);
                    let match = false;
                    if (filters) {
                        match = filters.every((record, _index, _arr) => {
                            const key = record[0];
                            const expected = record[1];
                            const actual = (0, util_1.findJsonValue)(propsObject, key);
                            return propertyMatchesFilter(actual, expected);
                        });
                        function propertyMatchesFilter(actual, expected) {
                            // For now we just check for strict equality, but we can implement pattern matching and fuzzy matching here later
                            return expected === actual;
                        }
                    }
                    if (match) {
                        const propsObj = (0, util_1.getResultObj)(propsObject, resource.Identifier, propertiesToReturn);
                        resultObjs.push(propsObj);
                    }
                }
            });
        }
        catch (err) {
            throw new error_1.ContextProviderError(`Could not get resources ${JSON.stringify(propertyMatch)}. Error: ${err}`);
        }
        return resultObjs;
    }
}
exports.CcApiContextProviderPlugin = CcApiContextProviderPlugin;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2MtYXBpLXByb3ZpZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2MtYXBpLXByb3ZpZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLCtEQUF3RjtBQUV4Riw0Q0FBd0Q7QUFDeEQsa0NBQXNEO0FBRXRELE1BQWEsMEJBQTBCO0lBQ3JDLFlBQTZCLEdBQWdCO1FBQWhCLFFBQUcsR0FBSCxHQUFHLENBQWE7SUFDN0MsQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNJLEtBQUssQ0FBQyxRQUFRLENBQUMsSUFBdUI7UUFDM0MsTUFBTSxZQUFZLEdBQUcsQ0FBQyxNQUFNLElBQUEscUNBQXNCLEVBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBRW5GLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDNUQsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUVPLEtBQUssQ0FBQyxhQUFhLENBQUMsRUFBdUIsRUFBRSxJQUF1QjtRQUMxRSxJQUFJLElBQUksQ0FBQyxlQUFlLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQy9DLE1BQU0sSUFBSSw0QkFBb0IsQ0FBQyxpSEFBaUgsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUM7UUFDcEssQ0FBQztRQUNELElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ2pELE1BQU0sSUFBSSw0QkFBb0IsQ0FBQywwR0FBMEcsSUFBSSxDQUFDLFFBQVEsR0FBRyxDQUFDLENBQUM7UUFDN0osQ0FBQztRQUVELElBQUksSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQ3pCLCtDQUErQztZQUMvQyxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxRQUFRLEVB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QUFBLG9CQUFhLEVBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxDQUFDOzRCQUMvQyxPQUFPLHFCQUFxQixDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQzt3QkFDakQsQ0FBQyxDQUFDLENBQUM7d0JBRUgsU0FBUyxxQkFBcUIsQ0FBQyxNQUFXLEVBQUUsUUFBaUI7NEJBQzNELGlIQUFpSDs0QkFDakgsT0FBTyxRQUFRLEtBQUssTUFBTSxDQUFDO3dCQUM3QixDQUFDO29CQUNILENBQUM7b0JBRUQsSUFBSSxLQUFLLEVBQUUsQ0FBQzt3QkFDVixNQUFNLFFBQVEsR0FBRyxJQUFBLG1CQUFZLEVBQUMsV0FBVyxFQUFFLFFBQVEsQ0FBQyxVQUFXLEVBQUUsa0JBQWtCLENBQUMsQ0FBQzt3QkFDckYsVUFBVSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztvQkFDNUIsQ0FBQztnQkFDSCxDQUFDO1lBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDO1FBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNiLE1BQU0sSUFBSSw0QkFBb0IsQ0FBQywyQkFBMkIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQzVHLENBQUM7UUFDRCxPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDO0NBQ0Y7QUF2SEQsZ0VBdUhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBDY0FwaUNvbnRleHRRdWVyeSB9IGZyb20gJ0Bhd3MtY2RrL2Nsb3VkLWFzc2VtYmx5LXNjaGVtYSc7XG5pbXBvcnQgdHlwZSB7IElDbG91ZENvbnRyb2xDbGllbnQgfSBmcm9tICcuLi9hcGknO1xuaW1wb3J0IHsgdHlwZSBTZGtQcm92aWRlciwgaW5pdENvbnRleHRQcm92aWRlclNkayB9IGZyb20gJy4uL2FwaS9hd3MtYXV0aC9zZGstcHJvdmlkZXInO1xuaW1wb3J0IHR5cGUgeyBDb250ZXh0UHJvdmlkZXJQbHVnaW4gfSBmcm9tICcuLi9hcGkvcGx1Z2luJztcbmltcG9ydCB7IENvbnRleHRQcm92aWRlckVycm9yIH0gZnJvbSAnLi4vdG9vbGtpdC9lcnJvcic7XG5pbXBvcnQgeyBmaW5kSnNvblZhbHVlLCBnZXRSZXN1bHRPYmogfSBmcm9tICcuLi91dGlsJztcblxuZXhwb3J0IGNsYXNzIENjQXBpQ29udGV4dFByb3ZpZGVyUGx1Z2luIGltcGxlbWVudHMgQ29udGV4dFByb3ZpZGVyUGx1Z2luIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBhd3M6IFNka1Byb3ZpZGVyKSB7XG4gIH1cblxuICAvKipcbiAgICogVGhpcyByZXR1cm5zIGEgZGF0YSBvYmplY3Qgd2l0aCB0aGUgdmFsdWUgZnJvbSBDbG91ZENvbnRyb2wgQVBJIHJlc3VsdC5cbiAgICogYXJncy50eXBlTmFtZSAtIHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vY2xvdWRjb250cm9sYXBpL2xhdGVzdC91c2VyZ3VpZGUvc3VwcG9ydGVkLXJlc291cmNlcy5odG1sXG4gICAqIGFyZ3MuZXhhY3RJZGVudGlmaWVyIC0gIHVzZSBDQyBBUEkgZ2V0UmVzb3VyY2UuXG4gICAqIGFyZ3MucHJvcGVydHlNYXRjaCAtIHVzZSBDQ1AgQVBJIGxpc3RSZXNvdXJjZXMgdG8gZ2V0IHJlc291cmNlcyBhbmQgcHJvcGVydHlNYXRjaCB0byBzZWFyY2ggdGhyb3VnaCB0aGUgbGlzdC5cbiAgICogYXJncy5wcm9wZXJ0aWVzVG9SZXR1cm4gLSBQcm9wZXJ0aWVzIGZyb20gQ0MgQVBJIHRvIHJldHVybi5cbiAgICovXG4gIHB1YmxpYyBhc3luYyBnZXRWYWx1ZShhcmdzOiBDY0FwaUNvbnRleHRRdWVyeSkge1xuICAgIGNvbnN0IGNsb3VkQ29udHJvbCA9IChhd2FpdCBpbml0Q29udGV4dFByb3ZpZGVyU2RrKHRoaXMuYXdzLCBhcmdzKSkuY2xvdWRDb250cm9sKCk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmZpbmRSZXNvdXJjZXMoY2xvdWRDb250cm9sLCBhcmdzKTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBmaW5kUmVzb3VyY2VzKGNjOiBJQ2xvdWRDb250cm9sQ2xpZW50LCBhcmdzOiBDY0FwaUNvbnRleHRRdWVyeSk6IFByb21pc2U8e1trZXk6IHN0cmluZ106IGFueX0gW10+IHtcbiAgICBpZiAoYXJncy5leGFjdElkZW50aWZpZXIgJiYgYXJncy5wcm9wZXJ0eU1hdGNoKSB7XG4gICAgICB0aHJvdyBuZXcgQ29udGV4dFByb3ZpZGVyRXJyb3IoYFNwZWNpZnkgZWl0aGVyIGV4YWN0SWRlbnRpZmllciBvciBwcm9wZXJ0eU1hdGNoLCBidXQgbm90IGJvdGguIEZhaWxlZCB0byBmaW5kIHJlc291cmNlcyB1c2luZyBDQyBBUEkgZm9yIHR5cGUgJHthcmdzLnR5cGVOYW1lfS5gKTtcbiAgICB9XG4gICAgaWYgKCFhcmdzLmV4YWN0SWRlbnRpZmllciAmJiAhYXJncy5wcm9wZXJ0eU1hdGNoKSB7XG4gICAgICB0aHJvdyBuZXcgQ29udGV4dFByb3ZpZGVyRXJyb3IoYE5laXRoZXIgZXhhY3RJZGVudGlmaWVyIG5vciBwcm9wZXJ0eU1hdGNoIGlzIHNwZWNpZmllZC4gRmFpbGVkIHRvIGZpbmQgcmVzb3VyY2VzIHVzaW5nIENDIEFQSSBmb3IgdHlwZSAke2FyZ3MudHlwZU5hbWV9LmApO1xuICAgIH1cblxuICAgIGlmIChhcmdzLmV4YWN0SWRlbnRpZmllcikge1xuICAgICAgLy8gdXNlIGdldFJlc291cmNlIHRvIGdldCB0aGUgZXhhY3QgaW5kZW50aWZpZXJcbiAgICAgIHJldHVybiB0aGlzLmdldFJlc291cmNlKGNjLCBhcmdzLnR5cGVOYW1lLCBhcmdzLmV4YWN0SWRlbnRpZmllciwgYXJncy5wcm9wZXJ0aWVzVG9SZXR1cm4pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyB1c2UgbGlzdFJlc291cmNlXG4gICAgICByZXR1cm4gdGhpcy5saXN0UmVzb3VyY2VzKGNjLCBhcmdzLnR5cGVOYW1lLCBhcmdzLnByb3BlcnR5TWF0Y2ghLCBhcmdzLnByb3BlcnRpZXNUb1JldHVybik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENhbGxzIGdldFJlc291cmNlIGZyb20gQ0MgQVBJIHRvIGdldCB0aGUgcmVzb3VyY2UuXG4gICAqIFNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vY2xpL2xhdGVzdC9yZWZlcmVuY2UvY2xvdWRjb250cm9sL2dldC1yZXNvdXJjZS5odG1sXG4gICAqXG4gICAqIElmIHRoZSBleGFjdElkZW50aWZpZXIgaXMgbm90IGZvdW5kLCB0aGVuIGFuIGVtcHR5IG1hcCBpcyByZXR1cm5lZC5cbiAgICogSWYgdGhlIHJlc291cmNlIGlzIGZvdW5kLCB0aGVuIGEgbWFwIG9mIHRoZSBpZGVudGlmaWVyIHRvIGEgbWFwIG9mIHByb3BlcnR5IHZhbHVlcyBpcyByZXR1cm5lZC5cbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZ2V0UmVzb3VyY2UoXG4gICAgY2M6IElDbG91ZENvbnRyb2xDbGllbnQsXG4gICAgdHlwZU5hbWU6IHN0cmluZyxcbiAgICBleGFjdElkZW50aWZpZXI6IHN0cmluZyxcbiAgICBwcm9wZXJ0aWVzVG9SZXR1cm46IHN0cmluZ1tdLFxuICApOiBQcm9taXNlPHtba2V5OiBzdHJpbmddOiBhbnl9W10+IHtcbiAgICBjb25zdCByZXN1bHRPYmpzOiB7W2tleTogc3RyaW5nXTogYW55fVtdID0gW107XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGNjLmdldFJlc291cmNlKHtcbiAgICAgICAgVHlwZU5hbWU6IHR5cGVOYW1lLFxuICAgICAgICBJZGVudGlmaWVyOiBleGFjdElkZW50aWZpZXIsXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IGlkID0gcmVzdWx0LlJlc291cmNlRGVzY3JpcHRpb24/LklkZW50aWZpZXIgPz8gJyc7XG4gICAgICBpZiAoaWQgIT09ICcnKSB7XG4gICAgICAgIGNvbnN0IHByb3BzT2JqZWN0ID0gSlNPTi5wYXJzZShyZXN1bHQuUmVzb3VyY2VEZXNjcmlwdGlvbj8uUHJvcGVydGllcyA/PyAnJyk7XG4gICAgICAgIGNvbnN0IHByb3BzT2JqID0gZ2V0UmVzdWx0T2JqKHByb3BzT2JqZWN0LCByZXN1bHQuUmVzb3VyY2VEZXNjcmlwdGlvbj8uSWRlbnRpZmllciEsIHByb3BlcnRpZXNUb1JldHVybik7XG4gICAgICAgIHJlc3VsdE9ianMucHVzaChwcm9wc09iaik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgQ29udGV4dFByb3ZpZGVyRXJyb3IoYENvdWxkIG5vdCBnZXQgcmVzb3VyY2UgJHtleGFjdElkZW50aWZpZXJ9LmApO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhyb3cgbmV3IENvbnRleHRQcm92aWRlckVycm9yKGBFbmNvdW50ZXJlZCBDQyBBUEkgZXJyb3Igd2hpbGUgZ2V0dGluZyByZXNvdXJjZSAke2V4YWN0SWRlbnRpZmllcn0uIEVycm9yOiAke2Vycn1gKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdE9ianM7XG4gIH1cblxuICAvKipcbiAgICogQ2FsbHMgbGlzdFJlc291cmNlcyBmcm9tIENDIEFQSSB0byBnZXQgdGhlIHJlc291cmNlcyBhbmQgYXBwbHkgYXJncy5wcm9wZXJ0eU1hdGNoIHRvIGZpbmQgdGhlIHJlc291cmNlcy5cbiAgICogU2VlIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9jbGkvbGF0ZXN0L3JlZmVyZW5jZS9jbG91ZGNvbnRyb2wvbGlzdC1yZXNvdXJjZXMuaHRtbFxuICAgKlxuICAgKiBTaW5jZSBleGFjdElkZW50aWZpZXIgaXMgbm90IHNwZWNpZmllZCwgcHJvcGVydHlNYXRjaCBtdXN0IGJlIHNwZWNpZmllZC5cbiAgICogVGhpcyByZXR1cm5zIGFuIG9iamVjdCB3aGVyZSB0aGUgaWRzIGFyZSBvYmplY3Qga2V5cyBhbmQgdmFsdWVzIGFyZSBvYmplY3RzIHdpdGgga2V5cyBvZiBhcmdzLnByb3BlcnRpZXNUb1JldHVybi5cbiAgICovXG4gIHByaXZhdGUgYXN5bmMgbGlzdFJlc291cmNlcyhcbiAgICBjYzogSUNsb3VkQ29udHJvbENsaWVudCxcbiAgICB0eXBlTmFtZTogc3RyaW5nLFxuICAgIHByb3BlcnR5TWF0Y2g6IFJlY29yZDxzdHJpbmcsIHVua25vd24+LFxuICAgIHByb3BlcnRpZXNUb1JldHVybjogc3RyaW5nW10sXG4gICk6IFByb21pc2U8e1trZXk6IHN0cmluZ106IGFueX1bXT4ge1xuICAgIGNvbnN0IHJlc3VsdE9ianM6IHtba2V5OiBzdHJpbmddOiBhbnl9W10gPSBbXTtcblxuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjYy5saXN0UmVzb3VyY2VzKHtcbiAgICAgICAgVHlwZU5hbWU6IHR5cGVOYW1lLFxuICAgICAgfSk7XG4gICAgICByZXN1bHQuUmVzb3VyY2VEZXNjcmlwdGlvbnM/LmZvckVhY2goKHJlc291cmNlKSA9PiB7XG4gICAgICAgIGNvbnN0IGlkID0gcmVzb3VyY2UuSWRlbnRpZmllciA/PyAnJztcbiAgICAgICAgaWYgKGlkICE9PSAnJykge1xuICAgICAgICAgIGNvbnN0IHByb3BzT2JqZWN0ID0gSlNPTi5wYXJzZShyZXNvdXJjZS5Qcm9wZXJ0aWVzID8/ICcnKTtcblxuICAgICAgICAgIGNvbnN0IGZpbHRlcnMgPSBPYmplY3QuZW50cmllcyhwcm9wZXJ0eU1hdGNoKTtcbiAgICAgICAgICBsZXQgbWF0Y2ggPSBmYWxzZTtcbiAgICAgICAgICBpZiAoZmlsdGVycykge1xuICAgICAgICAgICAgbWF0Y2ggPSBmaWx0ZXJzLmV2ZXJ5KChyZWNvcmQsIF9pbmRleCwgX2FycikgPT4ge1xuICAgICAgICAgICAgICBjb25zdCBrZXkgPSByZWNvcmRbMF07XG4gICAgICAgICAgICAgIGNvbnN0IGV4cGVjdGVkID0gcmVjb3JkWzFdO1xuICAgICAgICAgICAgICBjb25zdCBhY3R1YWwgPSBmaW5kSnNvblZhbHVlKHByb3BzT2JqZWN0LCBrZXkpO1xuICAgICAgICAgICAgICByZXR1cm4gcHJvcGVydHlNYXRjaGVzRmlsdGVyKGFjdHVhbCwgZXhwZWN0ZWQpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGZ1bmN0aW9uIHByb3BlcnR5TWF0Y2hlc0ZpbHRlcihhY3R1YWw6IGFueSwgZXhwZWN0ZWQ6IHVua25vd24pIHtcbiAgICAgICAgICAgICAgLy8gRm9yIG5vdyB3ZSBqdXN0IGNoZWNrIGZvciBzdHJpY3QgZXF1YWxpdHksIGJ1dCB3ZSBjYW4gaW1wbGVtZW50IHBhdHRlcm4gbWF0Y2hpbmcgYW5kIGZ1enp5IG1hdGNoaW5nIGhlcmUgbGF0ZXJcbiAgICAgICAgICAgICAgcmV0dXJuIGV4cGVjdGVkID09PSBhY3R1YWw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgICAgICBjb25zdCBwcm9wc09iaiA9IGdldFJlc3VsdE9iaihwcm9wc09iamVjdCwgcmVzb3VyY2UuSWRlbnRpZmllciEsIHByb3BlcnRpZXNUb1JldHVybik7XG4gICAgICAgICAgICByZXN1bHRPYmpzLnB1c2gocHJvcHNPYmopO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aHJvdyBuZXcgQ29udGV4dFByb3ZpZGVyRXJyb3IoYENvdWxkIG5vdCBnZXQgcmVzb3VyY2VzICR7SlNPTi5zdHJpbmdpZnkocHJvcGVydHlNYXRjaCl9LiBFcnJvcjogJHtlcnJ9YCk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHRPYmpzO1xuICB9XG59XG4iXX0=